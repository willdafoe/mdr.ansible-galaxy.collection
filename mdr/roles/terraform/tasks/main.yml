---
# tasks file for terraform
- name: "[role.terraform] setting terraform command"
  ansible.builtin.set_fact:
    command: '{{ item.value.name }}'
    state: '{{ item.value.state }}'
  when: tf_command is in item.key
  loop: "{{ lookup('ansible.builtin.dict', terraform_command, wantlist=True) }}"

- name: "[role.terraform] running terraform {{ command }}"
  block:
  - name: "[role.terraform] generating configuration template"
    include_tasks: template.yml
  
  - name: "[role.terraform] checking if plan file exists"
    ansible.builtin.stat:
      path: '{{ plan_file }}'
    register: run_plan
  
  - name: "[role.terraform] running plan"
    include_tasks: plan.yml
    when: run_plan.stat.exists == false
    register: apply_can_run
  when: command == "plan"

- ansible.builtin.debug:
    var: run_apply


